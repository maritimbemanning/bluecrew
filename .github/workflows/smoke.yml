name: smoke-tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Don't block deployment on smoke test failures, but report them
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build
        env:
          # Provide dummy env vars for build
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder

      - name: Start server
        run: |
          nohup npm start >/dev/null 2>&1 &
          echo "Waiting for server to start..."
          for i in {1..90}; do
            if curl -sSf http://localhost:3000/ >/dev/null 2>&1; then
              echo "Server is up after $i seconds"
              sleep 3
              break;
            fi
            if [ $i -eq 90 ]; then
              echo "ERROR: Server failed to start within 90 seconds"
              exit 1
            fi
            sleep 1
          done

      - name: Smoke test - public routes
        run: |
          echo "Testing public routes..."
          failed=0
          for route in / /jobbsoker /kunde /kontakt /om-oss /faq /cookies /personvern /vilkar; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000$route" || echo "000")
            echo "  $route -> $status"
            if [ "$status" != "200" ]; then
              echo "WARNING: $route returned $status (expected 200)"
              failed=1
            fi
          done
          if [ $failed -eq 1 ]; then
            echo "Some routes returned non-200 status"
            exit 1
          fi

      - name: Smoke test - /admin guard (should 404)
        run: |
          echo "Testing /admin guard..."
          status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/admin" || echo "000")
          echo "  /admin -> $status"
          if [ "$status" != "404" ]; then
            echo "WARNING: /admin returned $status (expected 404)"
          fi

      - name: Smoke test - robots and sitemap
        run: |
          echo "Testing SEO files..."
          status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/robots.txt" || echo "000")
          echo "  /robots.txt -> $status"
          if [ "$status" != "200" ]; then
            echo "ERROR: robots.txt returned $status"
            exit 1
          fi
          status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/sitemap.xml" || echo "000")
          echo "  /sitemap.xml -> $status"
          if [ "$status" != "200" ]; then
            echo "ERROR: sitemap.xml returned $status"
            exit 1
          fi

      - name: Smoke test - metadata and GDPR compliance
        run: |
          echo "Testing critical metadata..."
          html=$(curl -s "http://localhost:3000/" || echo "")
          
          # Check title
          if echo "$html" | grep -q '<title>'; then
            echo "  ✓ Title tag present"
          else
            echo "  ⚠ WARNING: Title tag missing"
          fi
          
          # Check GDPR cookie consent mention
          if echo "$html" | grep -iq 'cookie\|personvern\|gdpr'; then
            echo "  ✓ GDPR/privacy references found"
          else
            echo "  ⚠ WARNING: No GDPR/privacy references on homepage"
          fi
          
          # Check /personvern page exists
          status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/personvern" || echo "000")
          if [ "$status" = "200" ]; then
            echo "  ✓ Privacy policy page accessible (/personvern)"
          else
            echo "  ⚠ WARNING: Privacy policy returned $status"
          fi
          
          # Check /vilkar page exists  
          status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/vilkar" || echo "000")
          if [ "$status" = "200" ]; then
            echo "  ✓ Terms page accessible (/vilkar)"
          else
            echo "  ⚠ WARNING: Terms page returned $status"
          fi
